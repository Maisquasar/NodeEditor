#include "NodeManager.h"

#include "Node.h"

void NodeManager::AddNode(NodeRef node)
{
    node->AddInput("Input", Type::Float);
    node->AddInput("Input", Type::Float);
    node->AddInput("Input", Type::Float);
    node->AddOutput("Output", Type::Float);
    node->AddOutput("Output", Type::Float);
    node->AddOutput("Output", Type::Float);
    m_nodes.push_back(node);
    node->p_nodeManager = this;
}

void NodeManager::DrawNodes(float zoom, const Vec2f& origin, const Vec2f& mousePos)
{
    bool mouseClicked = ImGui::IsMouseClicked(ImGuiMouseButton_Left);
    NodeRef selectedNode = m_selectedNode.lock();
    bool wasNodeClicked = false;
    bool wasInputClicked = false;
    for (NodeRef& node : m_nodes)
    {
        bool alreadyOneSelected = selectedNode != m_selectedNode.lock();
        node->Draw(zoom, origin);

        if (mouseClicked)
        {
            for (int i = 0; i < node->p_inputs.size(); i++)
            {
                if (node->IsPointInsideCircle(mousePos, origin, zoom, i))
                {
                    m_selectedInput = node->GetInput(i);
                    alreadyOneSelected = true;
                    wasInputClicked = true;
                    break;
                }
            }
        }

        if (mouseClicked && !alreadyOneSelected && node->IsPointInNode(mousePos, origin, zoom))
        {
            SelectNode(node);
            
            m_firstClickOffset = mousePos;
            m_defaultPosition = node->p_position;

            wasNodeClicked = true;
        }

        for (int i = 0; i < node->p_outputs.size(); i++)
        {
        }
    }
    
    if (mouseClicked && !wasNodeClicked && !wasInputClicked)
    {
        SelectNode(nullptr);
    }

    NodeRef currentSelectedNode = m_selectedNode.lock();
    // Move selected node
    if (!m_selectedInput.lock() && currentSelectedNode && ImGui::IsMouseDown(ImGuiMouseButton_Left))
    {
        Vec2f newPosition = m_defaultPosition + (mousePos - m_firstClickOffset) / zoom;
        currentSelectedNode->SetPosition(newPosition);
    }
}

void NodeManager::SelectNode(NodeRef node)
{
    if (auto selectedNode = m_selectedNode.lock())
        selectedNode->p_selected = false;
    
    m_selectedNode = node;

    if (auto selectedNode = m_selectedNode.lock())
        selectedNode->p_selected = true;
    
}
